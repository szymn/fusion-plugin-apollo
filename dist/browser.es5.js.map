{"version":3,"file":"browser.es5.js","sources":["../src/server.js","../src/tokens.js","../src/plugin.js","../src/apollo-client/index.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env node */\nimport {getDataFromTree} from 'react-apollo';\nimport type {Logger} from 'fusion-tokens';\n\nimport type {Element} from 'react';\n\n// Apollo currently does not have an effective error policy for server side rendering (see https://github.com/apollographql/react-apollo/issues/2680)\n// This render function first tries to use `renderToStringWithData`. If any query in this render function fails, we will catch the error, log it, and\n// fall back to a standard renderToString, which will set the `loading` props of all queries which failed to execute in the first pass to true.\n// This allows us to still render with data in the happy case, and defer to client side rendering if any queries fail. This also acts as a form\n// of retrying from the browser.\nexport default (root: Element<*>, logger?: Logger) => {\n  return getDataFromTree(root).catch(e => {\n    logger && logger.error('SSR Failed with Error', e);\n  });\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport React from 'react';\nimport {createToken, type Context, type Token} from 'fusion-core';\nimport type {ApolloClient} from 'apollo-client';\n\nexport type InitApolloClientType<TInitialState> = (\n  ctx: Context,\n  initialState: TInitialState\n) => ApolloClient<TInitialState>;\n\n// We should have better flow types for the schema\nexport const GraphQLSchemaToken: Token<any> = createToken('GraphQlSchemaToken');\n\nexport type ApolloContext<T> = Context => T | T;\n\nexport const ApolloContextToken: Token<ApolloContext<mixed>> = createToken(\n  'ApolloContextToken'\n);\n\nexport const ApolloCacheContext = React.createContext<\n  $PropertyType<InitApolloClientType<mixed>, 'cache'>\n>();\n\nexport const GraphQLEndpointToken: Token<string> = createToken(\n  'GraphQLEndpointToken'\n);\n\nexport const ApolloClientToken: Token<\n  InitApolloClientType<mixed>\n> = createToken('ApolloClientToken');\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\nimport React from 'react';\n\nimport {createPlugin, html} from 'fusion-core';\n\nimport {ApolloProvider} from 'react-apollo';\n\nimport type {Context, Render} from 'fusion-core';\n\nimport serverRender from './server';\nimport {LoggerToken} from 'fusion-tokens';\nimport {ApolloServer} from 'apollo-server-koa';\nimport compose from 'koa-compose';\nimport {\n  ApolloContextToken,\n  ApolloCacheContext,\n  GraphQLSchemaToken,\n  GraphQLEndpointToken,\n  ApolloClientToken,\n} from './tokens';\n\nexport type DepsType = {\n  apolloContext: typeof ApolloContextToken.optional,\n  logger: typeof LoggerToken.optional,\n  schema: typeof GraphQLSchemaToken.optional,\n  endpoint: typeof GraphQLEndpointToken.optional,\n  getApolloClient: typeof ApolloClientToken,\n};\n\nexport type ProvidesType = (el: any, ctx: Context) => Promise<any>;\n\nfunction getDeps(): DepsType {\n  if (__NODE__) {\n    return {\n      apolloContext: ApolloContextToken.optional,\n      logger: LoggerToken.optional,\n      schema: GraphQLSchemaToken.optional,\n      endpoint: GraphQLEndpointToken.optional,\n      getApolloClient: ApolloClientToken,\n    };\n  }\n  // $FlowFixMe\n  return {\n    getApolloClient: ApolloClientToken,\n  };\n}\n\nexport default (renderFn: Render) =>\n  createPlugin<DepsType, ProvidesType>({\n    deps: getDeps(),\n    provides(deps) {\n      if (__BROWSER__) {\n        return renderFn;\n      }\n      return (el, ctx) => {\n        return serverRender(el, deps.logger).then(() => {\n          return renderFn(el, ctx);\n        });\n      };\n    },\n    middleware({\n      schema,\n      endpoint = '/graphql',\n      getApolloClient,\n      apolloContext = ctx => {\n        return ctx;\n      },\n    }) {\n      const renderMiddleware = async (ctx, next) => {\n        if (!ctx.element) {\n          return next();\n        }\n        let initialState = null;\n        if (__BROWSER__) {\n          // Deserialize initial state for the browser\n          const apolloState = document.getElementById('__APOLLO_STATE__');\n          if (apolloState) {\n            initialState = JSON.parse(unescape(apolloState.textContent));\n          }\n        }\n        // Create the client and apollo provider\n        const client = getApolloClient(ctx, initialState);\n        ctx.element = (\n          <ApolloCacheContext.Provider value={client.cache}>\n            <ApolloProvider client={client}>{ctx.element}</ApolloProvider>\n          </ApolloCacheContext.Provider>\n        );\n\n        await next();\n\n        if (__NODE__) {\n          // Serialize state into html on server side render\n          const initialState = client.cache && client.cache.extract();\n          const serialized = JSON.stringify(initialState);\n          const script = html`\n            <script type=\"application/json\" id=\"__APOLLO_STATE__\">\n              ${String(serialized)}\n            </script>\n          `;\n          ctx.template.body.push(script);\n        }\n      };\n      if (__NODE__ && schema) {\n        const server = new ApolloServer({\n          schema,\n          // investigate other options\n          context: ({ctx}) => {\n            if (typeof apolloContext === 'function') {\n              return apolloContext(ctx);\n            }\n            return apolloContext;\n          },\n        });\n        let serverMiddleware = [];\n        server.applyMiddleware({\n          // switch to server.getMiddleware once https://github.com/apollographql/apollo-server/pull/2435 lands\n          app: {\n            use: m => {\n              serverMiddleware.push(m);\n            },\n          },\n          // investigate other options\n          path: endpoint,\n        });\n        return compose([...serverMiddleware, renderMiddleware]);\n      } else {\n        return renderMiddleware;\n      }\n    },\n  });\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin, createToken} from 'fusion-core';\nimport {FetchToken} from 'fusion-tokens';\nimport {\n  GraphQLSchemaToken,\n  ApolloContextToken,\n  GraphQLEndpointToken,\n} from '../tokens';\nimport {ApolloClient} from 'apollo-client';\nimport {HttpLink} from 'apollo-link-http';\nimport {from as apolloLinkFrom} from 'apollo-link';\nimport {SchemaLink} from 'apollo-link-schema';\nimport type {ApolloCache, ApolloClientOptions} from 'apollo-client';\n\nimport type {Context, FusionPlugin, Token} from 'fusion-core';\nimport {InMemoryCache} from 'apollo-cache-inmemory';\n\nexport const GetApolloClientCacheToken: Token<\n  (ctx: Context) => ApolloCache<mixed>\n> = createToken('GetApolloClientCacheToken');\n\nexport const ApolloClientCredentialsToken: Token<string> = createToken(\n  'ApolloClientCredentialsToken'\n);\n\nexport const ApolloClientDefaultOptionsToken: Token<\n  $PropertyType<ApolloClientOptions<any>, 'defaultOptions'>\n> = createToken('ApolloClientDefaultOptionsToken');\n\ntype ApolloLinkType = {request: (operation: any, forward: any) => any};\n\nexport const GetApolloClientLinksToken: Token<\n  (Array<ApolloLinkType>, ctx: Context) => Array<ApolloLinkType>\n> = createToken('GetApolloClientLinksToken');\n\nexport const ApolloClientResolversToken: Token<\n  ResolverMapType | $ReadOnlyArray<ResolverMapType>\n> = createToken('ApolloClientResolversToken');\n\ntype ResolverMapType = {\n  +[key: string]: {\n    +[field: string]: (\n      rootValue?: any,\n      args?: any,\n      context?: any,\n      info?: any\n    ) => any,\n  },\n};\n\ntype ApolloClientDepsType = {\n  getCache: typeof GetApolloClientCacheToken.optional,\n  endpoint: typeof GraphQLEndpointToken.optional,\n  fetch: typeof FetchToken,\n  includeCredentials: typeof ApolloClientCredentialsToken.optional,\n  apolloContext: typeof ApolloContextToken.optional,\n  getApolloLinks: typeof GetApolloClientLinksToken.optional,\n  schema: typeof GraphQLSchemaToken.optional,\n  resolvers: typeof ApolloClientResolversToken.optional,\n  defaultOptions: typeof ApolloClientDefaultOptionsToken.optional,\n};\n\ntype InitApolloClientType = (\n  ctx: Context,\n  initialState: mixed\n) => ApolloClient<mixed>;\n\nfunction Container() {}\n\nconst ApolloClientPlugin: FusionPlugin<\n  ApolloClientDepsType,\n  InitApolloClientType\n> = createPlugin({\n  deps: {\n    getCache: GetApolloClientCacheToken.optional,\n    endpoint: GraphQLEndpointToken.optional,\n    fetch: FetchToken,\n    includeCredentials: ApolloClientCredentialsToken.optional,\n    apolloContext: ApolloContextToken.optional,\n    getApolloLinks: GetApolloClientLinksToken.optional,\n    schema: GraphQLSchemaToken.optional,\n    resolvers: ApolloClientResolversToken.optional,\n    defaultOptions: ApolloClientDefaultOptionsToken.optional,\n  },\n  provides({\n    getCache = ctx => new InMemoryCache(),\n    endpoint = '/graphql',\n    fetch,\n    includeCredentials = 'same-origin',\n    apolloContext = ctx => ctx,\n    getApolloLinks,\n    schema,\n    resolvers,\n    defaultOptions,\n  }) {\n    function getClient(ctx, initialState) {\n      const cache = getCache(ctx);\n      const connectionLink =\n        schema && __NODE__\n          ? new SchemaLink({\n              schema,\n              context:\n                typeof apolloContext === 'function'\n                  ? apolloContext(ctx)\n                  : apolloContext,\n            })\n          : new HttpLink({\n              uri: endpoint,\n              credentials: includeCredentials,\n              fetch,\n            });\n\n      const links: Array<ApolloLinkType> = getApolloLinks\n        ? getApolloLinks([connectionLink], ctx)\n        : [connectionLink];\n\n      const client = new ApolloClient({\n        ssrMode: __NODE__,\n        connectToDevTools: __BROWSER__ && __DEV__,\n        link: apolloLinkFrom(links),\n        cache: cache.restore(initialState),\n        resolvers,\n        defaultOptions,\n      });\n      return client;\n    }\n    return (ctx: Context, initialState: mixed) => {\n      if (ctx.memoized.has(Container)) {\n        return ctx.memoized.get(Container);\n      }\n      const client = getClient(ctx, initialState);\n      ctx.memoized.set(Container, client);\n      return client;\n    };\n  },\n});\nexport {ApolloClientPlugin};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport type {DocumentNode} from 'graphql';\nimport ApolloRenderEnhancer from './plugin';\n\nexport * from './tokens.js';\nexport * from './apollo-client/index.js';\n\nexport {ApolloRenderEnhancer};\n\nexport function gql(path: string): DocumentNode {\n  throw new Error('fusion-plugin-apollo/gql should be replaced at build time');\n}\n"],"names":["root","logger","getDataFromTree","catch","e","error","GraphQLSchemaToken","createToken","ApolloContextToken","ApolloCacheContext","React","createContext","GraphQLEndpointToken","ApolloClientToken","getDeps","getApolloClient","renderFn","createPlugin","deps","provides","el","ctx","serverRender","then","middleware","schema","endpoint","apolloContext","renderMiddleware","next","element","initialState","apolloState","document","getElementById","JSON","parse","unescape","textContent","client","cache","ApolloProvider","GetApolloClientCacheToken","ApolloClientCredentialsToken","ApolloClientDefaultOptionsToken","GetApolloClientLinksToken","ApolloClientResolversToken","Container","ApolloClientPlugin","getCache","optional","fetch","FetchToken","includeCredentials","getApolloLinks","resolvers","defaultOptions","InMemoryCache","getClient","connectionLink","SchemaLink","context","HttpLink","uri","credentials","links","ApolloClient","ssrMode","connectToDevTools","link","apolloLinkFrom","restore","memoized","has","get","set","gql","path","Error"],"mappings":";;;;;;;;;;;;;;;;AAAA;;;;;;;;;AASA,AAKA;;;;;AAKA,oBAAe,UAACA,IAAD,EAAmBC,MAAnB,EAAuC;SAC7CC,2BAAe,CAACF,IAAD,CAAf,CAAsBG,KAAtB,CAA4B,UAAAC,CAAC,EAAI;IACtCH,MAAM,IAAIA,MAAM,CAACI,KAAP,CAAa,uBAAb,EAAsCD,CAAtC,CAAV;GADK,CAAP;CADF;;ACnBA;;;;;;;AAOA,AASA;AACA,AAAO,IAAME,kBAA8B,GAAGC,sBAAW,CAAC,oBAAD,CAAlD;AAIP,AAAO,IAAMC,kBAA+C,GAAGD,sBAAW,CACxE,oBADwE,CAAnE;AAIP,AAAO,IAAME,kBAAkB,GAAGC,KAAK,CAACC,aAAN,EAA3B;AAIP,AAAO,IAAMC,oBAAmC,GAAGL,sBAAW,CAC5D,sBAD4D,CAAvD;AAIP,AAAO,IAAMM,iBAEZ,GAAGN,sBAAW,CAAC,mBAAD,CAFR;;;;;;;;;;;;;;;ACxBP,AA8BA,SAASO,OAAT,GAA6B;SAWpB;IACLC,eAAe,EAAEF;GADnB;;;AAKF,cAAe,UAACG,QAAD;SACbC,uBAAY,CAAyB;IACnCC,IAAI,EAAEJ,OAAO,EADsB;IAEnCK,QAFmC,oBAE1BD,IAF0B,EAEpB;MACI;eACRF,QAAP;;;aAEK,UAACI,EAAD,EAAKC,GAAL,EAAa;eACXC,YAAY,CAACF,EAAD,EAAKF,IAAI,CAACjB,MAAV,CAAZ,CAA8BsB,IAA9B,CAAmC,YAAM;iBACvCP,QAAQ,CAACI,EAAD,EAAKC,GAAL,CAAf;SADK,CAAP;OADF;KANiC;IAYnCG,UAZmC,4BAmBhC;UANDC,MAMC,QANDA,MAMC;+BALDC,QAKC;UALDA,QAKC,8BALU,UAKV;UAJDX,eAIC,QAJDA,eAIC;oCAHDY,aAGC;;UACKC,gBAAgB,GAAG,SAAnBA,gBAAmB,CAAOP,GAAP,EAAYQ,IAAZ;;cAInB,YAJmB,EAOf,WAPe,EAajB,MAbiB;;cACnB,CAACR,GAAG,CAACS,OAAT,EAAkB;2BACTD,IAAI,EAAX;;;UAEEE,YAAJ,GAAmB,IAAnB;;UACiB;YAETC,WAAN,GAAoBC,QAAQ,CAACC,cAAT,CAAwB,kBAAxB,CAApB;;gBACIF,WAAJ,EAAiB;cACfD,YAAY,GAAGI,IAAI,CAACC,KAAL,CAAWC,QAAQ,CAACL,WAAW,CAACM,WAAb,CAAnB,CAAf;;WATmB;;;UAajBC,MAAN,GAAexB,eAAe,CAACM,GAAD,EAAMU,YAAN,CAA9B;UACAV,GAAG,CAACS,OAAJ,GACE,oBAAC,kBAAD,CAAoB,QAApB;YAA6B,KAAK,EAAES,MAAM,CAACC;aACzC,oBAACC,0BAAD;YAAgB,MAAM,EAAEF;aAASlB,GAAG,CAACS,OAArC,CADF,CADF;iCAMMD,IAAI,EAAV,EAAA,IAAY;;;;;;oBAAZ;;OApBF;;MAyDO;eACED,gBAAP;;;GA9EM,CADC;CAAf;;ACvDA;;;;;;;AAQA,AAgBO,IAAMc,yBAEZ,GAAGnC,sBAAW,CAAC,2BAAD,CAFR;AAIP,AAAO,IAAMoC,4BAA2C,GAAGpC,sBAAW,CACpE,8BADoE,CAA/D;AAIP,AAAO,IAAMqC,+BAEZ,GAAGrC,sBAAW,CAAC,iCAAD,CAFR;AAMP,AAAO,IAAMsC,yBAEZ,GAAGtC,sBAAW,CAAC,2BAAD,CAFR;AAIP,AAAO,IAAMuC,0BAEZ,GAAGvC,sBAAW,CAAC,4BAAD,CAFR;;AAgCP,SAASwC,SAAT,GAAqB;;AAErB,IAAMC,kBAGL,GAAG/B,uBAAY,CAAC;EACfC,IAAI,EAAE;IACJ+B,QAAQ,EAAEP,yBAAyB,CAACQ,QADhC;IAEJxB,QAAQ,EAAEd,oBAAoB,CAACsC,QAF3B;IAGJC,KAAK,EAAEC,uBAHH;IAIJC,kBAAkB,EAAEV,4BAA4B,CAACO,QAJ7C;IAKJvB,aAAa,EAAEnB,kBAAkB,CAAC0C,QAL9B;IAMJI,cAAc,EAAET,yBAAyB,CAACK,QANtC;IAOJzB,MAAM,EAAEnB,kBAAkB,CAAC4C,QAPvB;IAQJK,SAAS,EAAET,0BAA0B,CAACI,QARlC;IASJM,cAAc,EAAEZ,+BAA+B,CAACM;GAVnC;EAYf/B,QAZe,0BAsBZ;6BATD8B,QASC;QATDA,QASC,8BATU,UAAA5B,GAAG;aAAI,IAAIoC,iCAAJ,EAAJ;KASb;6BARD/B,QAQC;QARDA,QAQC,8BARU,UAQV;QAPDyB,KAOC,QAPDA,KAOC;qCANDE,kBAMC;QANDA,kBAMC,sCANoB,aAMpB;kCALD1B,aAKC;QALDA,aAKC,mCALe,UAAAN,GAAG;aAAIA,GAAJ;KAKlB;QAJDiC,cAIC,QAJDA,cAIC;QAHD7B,MAGC,QAHDA,MAGC;QAFD8B,SAEC,QAFDA,SAEC;QADDC,cACC,QADDA,cACC;;aACQE,SAAT,CAAmBrC,GAAnB,EAAwBU,YAAxB,EAAsC;UAC9BS,KAAK,GAAGS,QAAQ,CAAC5B,GAAD,CAAtB;UACMsC,cAAc,GAClBlC,MAAM,SAAN,GACI,IAAImC,2BAAJ,CAAe;QACbnC,MAAM,EAANA,MADa;QAEboC,OAAO,EACL,OAAOlC,aAAP,KAAyB,UAAzB,GACIA,aAAa,CAACN,GAAD,CADjB,GAEIM;OALR,CADJ,GAQI,IAAImC,uBAAJ,CAAa;QACXC,GAAG,EAAErC,QADM;QAEXsC,WAAW,EAAEX,kBAFF;QAGXF,KAAK,EAALA;OAHF,CATN;UAeMc,KAA4B,GAAGX,cAAc,GAC/CA,cAAc,CAAC,CAACK,cAAD,CAAD,EAAmBtC,GAAnB,CADiC,GAE/C,CAACsC,cAAD,CAFJ;UAIMpB,MAAM,GAAG,IAAI2B,yBAAJ,CAAiB;QAC9BC,OAAO,OADuB;QAE9BC,iBAAiB,EAAE,6CAFW;QAG9BC,IAAI,EAAEC,eAAc,CAACL,KAAD,CAHU;QAI9BzB,KAAK,EAAEA,KAAK,CAAC+B,OAAN,CAAcxC,YAAd,CAJuB;QAK9BwB,SAAS,EAATA,SAL8B;QAM9BC,cAAc,EAAdA;OANa,CAAf;aAQOjB,MAAP;;;WAEK,UAAClB,GAAD,EAAeU,YAAf,EAAuC;UACxCV,GAAG,CAACmD,QAAJ,CAAaC,GAAb,CAAiB1B,SAAjB,CAAJ,EAAiC;eACxB1B,GAAG,CAACmD,QAAJ,CAAaE,GAAb,CAAiB3B,SAAjB,CAAP;;;UAEIR,MAAM,GAAGmB,SAAS,CAACrC,GAAD,EAAMU,YAAN,CAAxB;MACAV,GAAG,CAACmD,QAAJ,CAAaG,GAAb,CAAiB5B,SAAjB,EAA4BR,MAA5B;aACOA,MAAP;KANF;;CAtDY,CAHhB;;AC5EA;;;;;;;AAQA,AAOO,SAASqC,GAAT,CAAaC,IAAb,EAAyC;QACxC,IAAIC,KAAJ,CAAU,2DAAV,CAAN;;;;;;;;;;;;;;;;;"}