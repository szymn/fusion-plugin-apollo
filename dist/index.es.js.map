{"version":3,"file":"index.es.js","sources":["../src/server.js","../src/client.js","../src/tokens.js","../src/plugin.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env node */\nimport {renderToStringWithData} from 'react-apollo';\nimport {renderToString} from 'react-dom/server';\nimport type {Logger} from 'fusion-tokens';\n\nimport type {Element} from 'react';\n\n// Apollo currently does not have an effective error policy for server side rendering (see https://github.com/apollographql/react-apollo/issues/2680)\n// This render function first tries to use `renderToStringWithData`. If any query in this render function fails, we will catch the error, log it, and\n// fall back to a standard renderToString, which will set the `loading` props of all queries which failed to execute in the first pass to true.\n// This allows us to still render with data in the happy case, and defer to client side rendering if any queries fail. This also acts as a form\n// of retrying from the browser.\nexport default (root: Element<*>, logger?: Logger) => {\n  return renderToStringWithData(root)\n    .catch(e => {\n      logger && logger.error('SSR Failed with Error', e);\n      return renderToString(root);\n    })\n    .then(content => {\n      return `<div id='root'>${content}</div>`;\n    });\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\nimport ReactDOM from 'react-dom';\n\nimport type {Element} from 'react';\n\nexport default (root: Element<*>) => {\n  const domElement = document.getElementById('root');\n\n  if (!domElement) {\n    throw new Error(\"Could not find 'root' element\");\n  }\n\n  ReactDOM.hydrate\n    ? ReactDOM.hydrate(root, domElement)\n    : ReactDOM.render(root, domElement);\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport React from 'react';\nimport {createToken, type Context, type Token} from 'fusion-core';\nimport type {ApolloClient} from 'apollo-client';\n\nexport type InitApolloClientType<TInitialState> = (\n  ctx: Context,\n  initialState: TInitialState\n) => ApolloClient<TInitialState>;\n\n// We should have better flow types for the schema\nexport const GraphQLSchemaToken: Token<any> = createToken('GraphQlSchemaToken');\n\nexport type ApolloContext<T> = Context => T | T;\n\nexport const ApolloContextToken: Token<ApolloContext<mixed>> = createToken(\n  'ApolloContextToken'\n);\n\nexport const ApolloCacheContext = React.createContext<\n  $PropertyType<InitApolloClientType<mixed>, 'cache'>\n>();\n\nexport const GraphQLEndpointToken: Token<string> = createToken(\n  'GraphQLEndpointToken'\n);\n\nexport const ApolloClientToken: Token<\n  InitApolloClientType<mixed>\n> = createToken('ApolloClientToken');\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\nimport React from 'react';\n\nimport {createPlugin, html} from 'fusion-core';\n\nimport {ApolloProvider} from 'react-apollo';\n\nimport type {Context} from 'fusion-core';\nimport {prepare} from 'fusion-react';\n\nimport serverRender from './server';\nimport clientRender from './client';\nimport {LoggerToken} from 'fusion-tokens';\nimport {ApolloServer} from 'apollo-server-koa';\nimport compose from 'koa-compose';\nimport {\n  ApolloContextToken,\n  ApolloCacheContext,\n  GraphQLSchemaToken,\n  GraphQLEndpointToken,\n  ApolloClientToken,\n} from './tokens';\n\nexport type DepsType = {\n  apolloContext: typeof ApolloContextToken.optional,\n  logger: typeof LoggerToken.optional,\n  schema: typeof GraphQLSchemaToken.optional,\n  endpoint: typeof GraphQLEndpointToken.optional,\n  getApolloClient: typeof ApolloClientToken,\n};\n\nexport type ProvidesType = (el: any, ctx: Context) => Promise<any>;\n\nfunction getDeps(): DepsType {\n  if (__NODE__) {\n    return {\n      apolloContext: ApolloContextToken.optional,\n      logger: LoggerToken.optional,\n      schema: GraphQLSchemaToken.optional,\n      endpoint: GraphQLEndpointToken.optional,\n      getApolloClient: ApolloClientToken,\n    };\n  }\n  // $FlowFixMe\n  return {\n    getApolloClient: ApolloClientToken,\n  };\n}\n\nexport default createPlugin<DepsType, ProvidesType>({\n  deps: getDeps(),\n  provides(deps) {\n    return async (el, ctx) => {\n      return prepare(el).then(() => {\n        return __NODE__ ? serverRender(el, deps.logger) : clientRender(el);\n      });\n    };\n  },\n  middleware({\n    schema,\n    endpoint = '/graphql',\n    getApolloClient,\n    apolloContext = ctx => {\n      return ctx;\n    },\n  }) {\n    const renderMiddleware = (ctx, next) => {\n      if (!ctx.element) {\n        return next();\n      }\n      let initialState = null;\n      if (__BROWSER__) {\n        // Deserialize initial state for the browser\n        const apolloState = document.getElementById('__APOLLO_STATE__');\n        if (apolloState) {\n          initialState = JSON.parse(unescape(apolloState.textContent));\n        }\n      }\n      // Create the client and apollo provider\n      const client = getApolloClient(ctx, initialState);\n      ctx.element = (\n        <ApolloCacheContext.Provider value={client.cache}>\n          <ApolloProvider client={client}>{ctx.element}</ApolloProvider>\n        </ApolloCacheContext.Provider>\n      );\n\n      if (__NODE__) {\n        // Serialize state into html on server side render\n        const initialState = client.cache && client.cache.extract();\n        const serialized = JSON.stringify(initialState);\n        const script = html`\n          <script type=\"application/json\" id=\"__APOLLO_STATE__\">\n            ${serialized}\n          </script>\n        `;\n        ctx.template.body.push(script);\n      }\n\n      return next();\n    };\n    if (__NODE__ && schema) {\n      const server = new ApolloServer({\n        schema,\n        // investigate other options\n        context: ({ctx}) => {\n          if (typeof apolloContext === 'function') {\n            return apolloContext(ctx);\n          }\n          return apolloContext;\n        },\n      });\n      let serverMiddleware = [];\n      server.applyMiddleware({\n        // switch to server.getMiddleware once https://github.com/apollographql/apollo-server/pull/2435 lands\n        app: {\n          use: m => {\n            serverMiddleware.push(m);\n          },\n        },\n        // investigate other options\n        path: endpoint,\n      });\n      return compose([...serverMiddleware, renderMiddleware]);\n    } else {\n      return renderMiddleware;\n    }\n  },\n});\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport type {DocumentNode} from 'graphql';\nimport Plugin from './plugin';\n\nexport * from './tokens.js';\nexport default Plugin;\n\nexport function gql(path: string): DocumentNode {\n  throw new Error('fusion-plugin-apollo/gql should be replaced at build time');\n}\n"],"names":["root","logger","renderToStringWithData","catch","e","error","renderToString","then","content","GraphQLSchemaToken","createToken","ApolloContextToken","ApolloCacheContext","React","createContext","GraphQLEndpointToken","ApolloClientToken","getDeps","apolloContext","optional","LoggerToken","schema","endpoint","getApolloClient","createPlugin","deps","provides","el","ctx","prepare","serverRender","middleware","renderMiddleware","next","element","initialState","client","cache","extract","serialized","JSON","stringify","script","html","template","body","push","server","ApolloServer","context","serverMiddleware","applyMiddleware","app","use","m","path","compose","gql","Error"],"mappings":"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"}